<!-- b22b977e-a012-4d40-b0cc-228d5ad7fac7 5f2f9096-a2bc-4018-957b-3f52adf6f07a -->
# Re-apply SIWE + Auth refactor edits (code-only, 1:1 with staged diffs)

## Scope and assumptions

- Code edits only (no local env/run/migration execution).
- Implement SIWE (Sign-In with Ethereum) alongside existing OAuth; use `checkHybridAuth` in routes.
- Add `walletAddress` to users and surface via APIs/UI.
- Enforce project style (no semicolons, descriptive names) [[memory:8867659]].

## High-level change map by area

- Database: Add `walletAddress` to `User`; create migration `0077_add_wallet_address_to_user.sql`; update `apps/sim/db/schema.ts`.
- Auth core: Add SIWE cookie helpers for Node and Edge; derive internal secret; extend internal JWT utils; hybrid auth via `checkHybridAuth`.
- API auth: Add SIWE endpoints (`nonce`, `verify`, `logout`) and `auth/me`; update `auth/socket-token`.
- Middleware/security: Recognize SIWE session in middleware; extend CSP for wallet infrastructure; add internal secret utility.
- Redis: Use `getRedisClient()` directly for nonce storage in routes (5 min TTL).
- Frontend auth UI: Add wallet connect button and flow; integrate into login.
- API routes: Replace legacy session getters with `checkHybridAuth` in modified routes.
- Socket server: Accept SIWE-minted internal socket JWTs in middleware.
- State/contexts/stores: Update socket context and organization store.
- Package/configs: Add dependencies in `apps/sim/package.json`; update `.gitignore`; update `biome.json` line endings.

---

## Detailed steps (exact behaviors)

### 1) Database schema and migration

- Create `apps/sim/db/migrations/0077_add_wallet_address_to_user.sql`:
  ```sql
  ALTER TABLE "user" ADD COLUMN IF NOT EXISTS "wallet_address" text;
  ALTER TABLE "user" ADD CONSTRAINT IF NOT EXISTS "user_wallet_address_unique" UNIQUE("wallet_address");
  ```

- Update `apps/sim/db/schema.ts`:
  - In `user` table, add `walletAddress: text('wallet_address').unique()`.

### 2) Auth core

- `apps/sim/lib/auth/siwe-cookie.ts` (Node):
  - `encodeSignedSiweCookie(payload)` → HS256 JWS with claims `{ uid, addr }` using `getInternalApiSecretKey()`.
  - `decodeAndVerifySiweCookie(value)` → returns `{ uid, addr, iat, exp } | null`.
  - `decodeLegacySiweCookie(value)` and `parseUnsignedSignedSiweCookie(value)` included exactly as in staged diffs.
- `apps/sim/lib/auth/siwe-cookie-edge.ts` (Edge):
  - Derive secret with WebCrypto HMAC-SHA-256 over label `sim-internal-api-secret-v1` from env; encode/verify HS256 as above.
- `apps/sim/lib/security/internal-secret.ts`:
  - Export `getInternalApiSecretKey()`; use `INTERNAL_API_SECRET` when ≥32 chars; else derive HMAC-SHA-256 over label using `BETTER_AUTH_SECRET` or `ENCRYPTION_KEY`.
- `apps/sim/lib/auth/internal.ts`:
  - Use `getInternalApiSecretKey()` to sign/verify internal JWTs; issuer `sim-internal`, audience `sim-api`, 5m expiry.
- `apps/sim/lib/auth/hybrid.ts`:
  - Export `checkHybridAuth(request, options?)` precedence:

1) Internal JWT via `Authorization: Bearer` (optionally with `workflowId` resolution for internal calls)

2) Better Auth session via `getSession()`

3) Signed SIWE cookie `siwe_session` via `decodeAndVerifySiweCookie`

4) API key from `x-api-key`

  - Returns `{ success, userId, authType }`.

### 3) Auth API

- `apps/sim/app/api/auth/siwe/nonce/route.ts`:
  - `GET`: generate `siwe.generateNonce()`, store `siwe:nonce:{nonce}` in Redis for 5 minutes when a client exists, and return nonce as `text/plain`.
- `apps/sim/app/api/auth/siwe/verify/route.ts`:
  - `POST { message, signature }`: verify with `new SiweMessage(message).verify({ signature, domain })` where domain is `host` of `NEXT_PUBLIC_APP_URL` or `localhost`.
  - If Redis is configured, require `siwe:nonce:{nonce}` to exist and delete it.
  - Normalize address with `ethers v6.x getAddress`.
  - If Better Auth session exists, ensure address uniqueness then set `walletAddress` on that user; else upsert by `walletAddress` and create minimal user record.
  - Issue `siwe_session` cookie (HS256 via `getInternalApiSecretKey()`), claims `{ uid, addr }`, 24h, `HttpOnly`, `SameSite=Lax`, `Secure` unless localhost.
  - Respond `{ ok: true }`.
- `apps/sim/app/api/auth/siwe/logout/route.ts`:
  - `POST`: clear `siwe_session` cookie (maxAge 0).
- `apps/sim/app/api/auth/me/route.ts`:
  - `GET`: if Better Auth session present, return `{ userId, email, walletAddress: null }`; else if signed SIWE cookie present, return `{ userId: uid, email: addr@wallet.user, walletAddress: addr }`; else all nulls.
- `apps/sim/app/api/auth/socket-token/route.ts`:
  - Attempt `auth.api.generateOneTimeToken` first.
  - If not available or on error but a valid SIWE cookie exists, mint internal HS256 JWT with claims `{ type: 'socket', userId: uid }` (5m) and return `{ token }`.

### 4) Middleware and security

- `apps/sim/middleware.ts`:
  - Treat user as authenticated if Better Auth session cookie or a valid `siwe_session` is present (via `decodeAndVerifySiweCookieEdge`).
  - Keep existing redirects and CSP behavior; apply dynamic CSP where applicable.
- `apps/sim/lib/security/csp.ts`:
  - Add exact hosts for wallet connectivity:
    - `connect-src`: `https://cloudflare-eth.com`, `https://rpc.ankr.com`, `wss://relay.walletconnect.com`, `https://rpc.walletconnect.com`
  - Add `https://rsms.me` to `font-src`.
  - Keep all other existing sources; build-time/runtime string construction unchanged except additions above.

### 5) Redis

- `apps/sim/lib/redis.ts`:
  - `getRedisClient()` initializes only when `REDIS_URL` is set; nonce storage for SIWE is done directly inside the nonce route.

### 6) Environment typing

- `apps/sim/lib/env.ts` additions used by staged code:
  - Server keys: `SIM_AGENT_API_KEY`, `FREESTYLE_API_KEY`, `COPILOT_COST_MULTIPLIER` (and existing auth/billing keys kept), plus consolidation of several branding/support keys.
  - Client keys: `NEXT_PUBLIC_WALLETCONNECT_PROJECT_ID`, `NEXT_PUBLIC_SUPPORT_URL`, brand color keys and aliases:
    - `NEXT_PUBLIC_BRAND_PRIMARY`, `NEXT_PUBLIC_BRAND_SECONDARY`, `NEXT_PUBLIC_BRAND_ACCENT`
    - `NEXT_PUBLIC_BRAND_PRIMARY_COLOR`, `NEXT_PUBLIC_BRAND_SECONDARY_COLOR`, `NEXT_PUBLIC_BRAND_ACCENT_COLOR`
  - Ensure these are exported in `experimental__runtimeEnv`.

### 7) API routes refactor pattern

- For modified routes (e.g., `apps/sim/app/api/workflows/[id]/route.ts`, OAuth utils, tools routes, etc.):
  - Replace legacy session fetches with `checkHybridAuth(request)` for auth.
  - Preserve response shapes; apply per-route access checks as already coded in the diffs.

### 8) Frontend auth UI

- `apps/sim/app/(auth)/components/social-login-buttons.tsx`:
  - Initialize Web3 Onboard with Injected wallets and WalletConnect v2 using `NEXT_PUBLIC_WALLETCONNECT_PROJECT_ID`; chain `id: '0x1'`, RPC `https://rpc.ankr.com/eth`.
  - Button "Continue with Wallet": connect, GET `/api/auth/siwe/nonce` (plaintext), build SIWE message with checksummed address, sign via `ethers v6.x BrowserProvider`, POST `/api/auth/siwe/verify`, then redirect to callbackURL.
- `apps/sim/app/(auth)/login/login-form.tsx`:
  - Render wallet option alongside GitHub/Google and the email form, with an `or` divider.

### 9) Workspace UI page

- `apps/sim/app/workspace/empty/page.tsx`:
  - Adds empty-state page with "Create workspace" button that POSTs to `/api/workspaces` and redirects on success.

### 10) Contexts, stores, sockets

- `apps/sim/contexts/socket-context.tsx`:
  - Resolve effective user via `/api/auth/me` if Better Auth user not provided, then initialize Socket.IO using `/api/auth/socket-token`.
  - On connection/reconnection, join room for current `urlWorkflowId`. Includes event wiring, presence updates, operation throttling. Uses tokens minted as above.
- `apps/sim/socket-server/middleware/auth.ts`:
  - Accept Better Auth one-time tokens or internal HS256 socket tokens (claims `{ type: 'socket', userId }`) and attach user context to socket.
- `apps/sim/socket-server/database/operations.ts`:
  - Reliability updates: safe inserts for edges with `onConflictDoNothing`, detailed logging, subflow list synchronization, robust CRUD handling for blocks/edges/variables.
- `apps/sim/stores/organization/store.ts`:
  - Use credentialed fetch (`credentials: 'include'`) for billing/workspaces where applicable; maintain organization subscription/billing flows and admin workspace filtering.

### 11) Packages and configs

- `apps/sim/package.json` dependencies:
  - Add: `siwe@^2.3.2`, `ethers@^6.13.4`, `@web3-onboard/core@^2.20.2`, `@web3-onboard/injected-wallets@^2.10.9`, `@web3-onboard/walletconnect@2.6.2`.
- `.gitignore`: add `/.idea/`, `/patches/`, `/.cursor/rules/architecture.mdc`, `/apps/sim/.npmrc`, `/create_patch.ps1`.
- `biome.json`: set `lineEnding` to `crlf` (retain other settings).

---

## File-by-file checklist

- `.gitignore`: add entries listed above.
- `apps/sim/app/(auth)/components/social-login-buttons.tsx`: Web3 Onboard + SIWE connect flow.
- `apps/sim/app/(auth)/login/login-form.tsx`: include wallet option and divider.
- `apps/sim/app/api/auth/siwe/{nonce,verify,logout}/route.ts`: plaintext nonce; verify sets HS256 `siwe_session` with `{ uid, addr }`; logout clears cookie.
- `apps/sim/app/api/auth/me/route.ts`: return `{ userId, email, walletAddress }` based on Better Auth session or SIWE cookie.
- `apps/sim/app/api/auth/socket-token/route.ts`: issue Better Auth token or internal HS256 `{ type: 'socket', userId }` for SIWE sessions.
- Modified `apps/sim/app/api/**` (e.g., `workflows/[id]`, oauth utils): standardize on `checkHybridAuth`.
- `apps/sim/app/workspace/empty/page.tsx`: empty-state creator page.
- `apps/sim/db/migrations/0077_add_wallet_address_to_user.sql`: add unique text column.
- `apps/sim/db/schema.ts`: add `walletAddress` unique column.
- `apps/sim/lib/auth/{hybrid.ts,internal.ts}`: hybrid auth + internal JWT updates.
- `apps/sim/lib/auth/{siwe-cookie.ts,siwe-cookie-edge.ts}`: cookie helpers per above.
- `apps/sim/lib/env.ts`: add keys noted above and export to runtime env.
- `apps/sim/lib/security/{csp.ts,internal-secret.ts}`: CSP sources and secret derivation.
- `apps/sim/middleware.ts`: recognize SIWE cookie as active session.
- `apps/sim/contexts/socket-context.tsx`: SIWE-aware socket token and room joins.
- `apps/sim/socket-server/{middleware/auth.ts,database/operations.ts}`: socket auth for internal JWTs and DB reliability updates.
- `apps/sim/stores/organization/store.ts`: credentialed fetch and org/billing enhancements.
- `apps/sim/package.json`: add deps listed.
- `biome.json`: `lineEnding: crlf`.

---

## To-dos

- [ ] Create migration 0077 and add unique `wallet_address` column
- [ ] Update users schema with `walletAddress` unique field
- [ ] Add Node and Edge SIWE cookie helpers
- [ ] Implement `checkHybridAuth` precedence in `lib/auth/hybrid.ts`
- [ ] Add SIWE nonce/verify/logout endpoints and `auth/me`
- [ ] Update `socket-token` to mint internal HS256 `{ type: 'socket', userId }` if SIWE
- [ ] Refactor modified API routes to use `checkHybridAuth`
- [ ] Add Web3 Onboard wallet flow to social buttons and login form
- [ ] Add workspace empty page
- [ ] Update middleware to recognize SIWE session
- [ ] Update CSP hosts, internal secret derivation
- [ ] Update env typings and runtime exposure (keys listed)
- [ ] Update socket server auth and DB operations
- [ ] Add deps; update `.gitignore`; set `lineEnding` to `crlf` in `biome.json`

### To-dos

- [ ] Create migration 0077 to add wallet_address and unique index
- [ ] Update users schema to include walletAddress field
- [ ] Add siwe-cookie helpers for node and edge runtimes
- [ ] Implement getAuth hybridizing OAuth and SIWE in lib/auth/hybrid.ts
- [ ] Add SIWE nonce, verify, logout API routes and auth/me
- [ ] Add Redis helpers to store/consume SIWE nonces
- [ ] Update middleware and CSP; add internal-secret utility
- [ ] Update socket-token route to accept SIWE and mint claims
- [ ] Refactor modified API routes to use getAuth and keep shapes
- [ ] Add Connect Wallet in social-login and login form
- [ ] Update workspace settings/header/sidebar and add empty page
- [ ] Update contexts, hooks, and stores for wallet-aware state
- [ ] Update socket server middleware and operations for SIWE
- [ ] Update package.json deps and biome config if needed