<!-- 470dad11-2867-4f9e-a748-f41ac9470f8d 914f8762-5f97-4373-a4d5-f08205d20891 -->
# Crypto-Only Wallet Login (SIWE) — minimal, component-based

### Goal

Ship wallet-only authentication with the smallest viable surface area change. Keep all server call sites of `getSession()` intact by swapping its internals to a SIWE-backed session. Add SIWE endpoints, a signed cookie, a dedicated client session endpoint, and a new wallet login UI component (same visual style as current login). Honor `NEXT_PUBLIC_WALLET_ONLY_AUTH=true`.

### Key Decisions

- Server surfaces: do not change any server call sites; keep using `getSession()` everywhere and replace its internals to read the SIWE cookie and synthesize a Better Auth-shaped object.
- Client session: do not rely on Better Auth’s client session. Add a tiny `GET /api/auth/siwe/session` endpoint and switch `SessionProvider` to fetch it.
- Middleware: accept SIWE cookie in addition to Better Auth cookie.
- UI: add a new wallet login component with the same style as the current page and render it exclusively when `NEXT_PUBLIC_WALLET_ONLY_AUTH=true`.

### Files to Add or Edit

1) Server auth helper (keep server API shape stable)

- Edit `apps/sim/lib/auth.ts`:
- Replace `getSession()` implementation to:
- Read `siwe_session` cookie, verify signature, load user, return `{ user, session: { activeOrganizationId? }, expiresAt }`.
- Return `null` when no SIWE session.
- Keep all exports and Better Auth configuration intact to avoid cascading changes.

2) SIWE cookie utilities

- Use `INTERNAL_API_SECRET` for HMAC derivation (no new secret file required).
- Add `apps/sim/lib/auth/siwe-cookie.ts`: encode/verify signed `siwe_session` using HMAC-SHA256 (via `jose`), payload `{ uid, addr, iat, exp }`. Export helpers that work in Node and Edge.

3) SIWE API routes

- Add `apps/sim/app/api/auth/siwe/nonce/route.ts`: `GET` generates nonce, optional Redis single-use TTL (300s).
- Add `apps/sim/app/api/auth/siwe/verify/route.ts`: `POST { message, signature }`; verify EIP-4361, enforce Redis nonce if present, find-or-create user by `wallet_address`, set `siwe_session` cookie (24h).
- Add `apps/sim/app/api/auth/siwe/logout/route.ts`: `POST` clears `siwe_session`.
- Add `apps/sim/app/api/auth/siwe/session/route.ts`: `GET` returns the same object as server `getSession()` for client fetching.

4) Middleware

- Edit `apps/sim/middleware.ts` to accept SIWE cookie via `verifySiweCookie` (from `siwe-cookie.ts`) and set `hasActiveSession` accordingly. Keep existing redirects. You may later remove Better Auth cookie reads if going strictly crypto-only.

5) Client wallet login UI (new component, same style)

- Add `apps/sim/app/(auth)/components/wallet-login.tsx`:
- New component styled identically to current login page buttons/sections.
- Implement WalletConnect v2 + Injected using Web3 Onboard (or wagmi/viem) and ethers v6.
- Flow: connect → GET `/api/auth/siwe/nonce` → sign EIP‑4361 → POST `/api/auth/siwe/verify` → redirect `/workspace`.
- Edit `apps/sim/app/(auth)/login/page.tsx` and `apps/sim/app/(auth)/login/login-form.tsx`:
- When `NEXT_PUBLIC_WALLET_ONLY_AUTH=true`, render the new wallet component and hide email/social/SSO controls.
- Otherwise, keep existing behavior.

6) Real-time socket token (required for wallet-only)

- Edit `apps/sim/app/api/auth/socket-token/route.ts`:
- If Better Auth one-time token fails or no BA session, verify SIWE cookie and mint internal short-lived JWT `{ type: 'socket', userId }` using `INTERNAL_API_SECRET`.
- Edit `apps/sim/socket-server/middleware/auth.ts`:
- If Better Auth token verification fails, verify the internal JWT and set `socket.userId`.

7) Database

- Add `user.wallet_address` (lowercased, unique). Current schema requires `email` and `name` as NOT NULL, so create users as:
- `email`: `<wallet_address>@wallet.local` (synthetic, unique)
- `name`: short display (e.g., `0xabc…1234`)
- `emailVerified`: true

8) Environment / Config

- Required:
- `INTERNAL_API_SECRET` (≥ 32 chars)
- `DATABASE_URL`, `NEXT_PUBLIC_APP_URL`
- Optional:
- `REDIS_URL` (enforce nonce one-time use)
- `NEXT_PUBLIC_WALLETCONNECT_PROJECT_ID` (WalletConnect v2)
- `NEXT_PUBLIC_WALLET_ONLY_AUTH=true`
- Update `.env.example` and local envs (do not commit secrets).

9) Dependencies (apps/sim/package.json)

- Add: `siwe`, `ethers@^6`, and either `@web3-onboard/core` (+ injected + walletconnect modules) or `wagmi` + `viem` + `@walletconnect/ethereum-provider`.

### Implementation Notes

- Coding style: TypeScript without semicolons; step-by-step comments in new code; full variable names; use "ethers v6.x" in comments.
- SIWE cookie: `httpOnly`, `secure`, `sameSite: 'lax'`, `path: '/'`, `maxAge` aligned to `exp`.
- Domain check: use `new URL(req.url).host` and match `SiweMessage.domain`.
- Chains: default to Ethereum Mainnet; extend later as needed.
- Use `jose` for HMAC signing/verification to support Node + Edge.
- Login UI: replicate existing classes/spacing/typography; keep the visual parity with the current login form/buttons.

### QA Checklist

- Injected wallet login (MetaMask) on desktop
- WalletConnect v2 on mobile with real project ID
- Nonce single-use with and without Redis
- `getSession()` returns a session for SIWE cookie; downstream pages and API routes continue to work
- Client session loads via `/api/auth/siwe/session` and UI shows user
- Middleware accepts SIWE and redirects unauthenticated users to `/login`
- Socket connects via SIWE fallback JWT when BA token is unavailable
- Logout clears SIWE cookie and returns to `/login`
- User auto-created on first SIWE verify; `wallet_address` stored lowercase; synthetic email/name present

### Rollback

- Toggle off wallet-only by removing `NEXT_PUBLIC_WALLET_ONLY_AUTH` and restoring original `getSession()` (version control).
- Remove SIWE acceptance in middleware and routes if needed to revert quickly.

### To-dos

- [ ] Create nonce, verify, logout routes under /app/api/auth/siwe
- [ ] Run QA checklist across injected and WalletConnect v2